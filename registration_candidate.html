<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - HireMe</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #2563EB;
            --primary-hover: #1D4ED8;
            --accent: #8B5CF6;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --bg-light: #F8FAFC;
            --text-dark: #1E293B;
            --text-gray: #64748B;
            --white: #FFFFFF;
            --border: #E2E8F0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--white) 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .registration-container {
            max-width: 480px;
            margin: 40px auto;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .registration-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--white);
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--white);
            z-index: 10;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .registration-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 5;
        }

        .registration-header p {
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 5;
        }

        .registration-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-gray);
            opacity: 0.7;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: var(--white);
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: var(--bg-light);
        }

        /* Стили для переключателя статуса */
        .status-toggle {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: var(--bg-light);
            border-radius: var(--radius);
        }

        .status-label {
            flex: 1;
            font-weight: 600;
            color: var(--text-dark);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .status-description {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .status-active {
            color: var(--success);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--text-gray);
        }

        .btn-primary {
            width: 100%;
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo h2 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 800;
        }

        /* Стили для выбора валюты */
        .salary-container {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .salary-input {
            flex: 1;
        }

        .salary-input .form-input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        .currency-select-wrapper {
            position: relative;
            width: 120px;
        }

        .currency-select {
            width: 100%;
            height: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0 8px 8px 0;
            font-size: 1rem;
            background: var(--bg-light);
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .currency-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .currency-select-wrapper::after {
            content: "▼";
            font-size: 0.8rem;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-gray);
        }

        /* Анимации */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .registration-container {
            animation: slideIn 0.6s ease-out;
        }

        /* Адаптивность */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .registration-container {
                margin: 20px auto;
            }

            .registration-header {
                padding: 1.5rem;
            }

            .back-button {
                top: 0.8rem;
                left: 0.8rem;
                width: 36px;
                height: 36px;
            }

            .registration-header h1 {
                font-size: 1.5rem;
                padding: 0 2.5rem;
            }

            .registration-header p {
                padding: 0 1rem;
            }

            .registration-body {
                padding: 1.5rem;
            }

            .currency-select-wrapper {
                width: 100px;
            }

            .currency-select {
                padding: 1rem 0.8rem;
                font-size: 0.9rem;
            }

            .currency-select-wrapper::after {
                right: 8px;
            }
        }

        /* Состояния загрузки */
        .loading {
            position: relative;
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid var(--white);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="logo">
    <h2>HireMe</h2>
</div>

<div class="registration-container">
    <div class="registration-header">
        <button class="back-button" onclick="goBack()">←</button>
        <h1>📝 Завершите регистрацию</h1>
        <p>Заполните данные для вашего профиля</p>
    </div>

    <div class="registration-body">
        <form id="regForm">
            <div class="form-group">
                <label for="firstName">Имя</label>
                <input type="text" id="firstName" name="firstName" class="form-input" placeholder="Введите ваше имя" required>
            </div>

            <div class="form-group">
                <label for="lastName">Фамилия</label>
                <input type="text" id="lastName" name="lastName" class="form-input" placeholder="Введите вашу фамилию" required>
            </div>

            <div class="form-group">
                <label for="desiredPosition">Должность</label>
                <div class="autocomplete-container">
                    <input type="text" id="desiredPosition" name="desiredPosition" class="form-input" placeholder="Начните вводить название должности" autocomplete="off" required>
                    <div class="autocomplete-dropdown" id="positionDropdown"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="desiredSalary">Ожидаемый доход</label>
                <div class="salary-container">
                    <div class="salary-input">
                        <input type="text" id="desiredSalary" name="desiredSalary" class="form-input" placeholder="250 000" inputmode="numeric" required>
                    </div>
                    <div class="currency-select-wrapper">
                        <select id="currency" name="currency" class="currency-select">
                            <option value="RUB">₽ RUB</option>
                            <option value="USD">$ USD</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Блок статуса поиска работы -->
            <div class="status-toggle">
                <span class="status-label">Статус поиска работы</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="candidateJobStatus" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="status-description">
                <span id="statusText" class="status-active">✅ В активном поиске</span>
                <p id="statusHelp">Работодатели увидят ваш профиль и смогут предлагать вам вакансии</p>
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">
                ✅ Сохранить профиль
            </button>
        </form>
    </div>
</div>

<script>
    // Инициализация Telegram WebApp
    let tg = window.Telegram.WebApp;

    // Раскрываем на весь экран и меняем цвет тему
    tg.expand();
    tg.setHeaderColor('#2563EB');
    tg.setBackgroundColor('#F8FAFC');

    // Список доступных должностей
    const positions = [
        "Frontend Developer",
        "Backend Developer",
        "Fullstack Developer",
        "Java Developer",
        "Python Developer",
        "JavaScript Developer",
        "DevOps Engineer",
        "Data Scientist",
        "UI/UX Designer",
        "Project Manager",
        "QA Engineer",
        "Mobile Developer",
        "iOS Developer",
        "Android Developer",
        "System Administrator",
        "Product Manager",
        "Business Analyst",
        "Team Lead",
        "CTO",
        "Scrum Master",
        "Data Engineer",
        "Machine Learning Engineer",
        "Cloud Architect",
        "Network Engineer",
        "Security Specialist"
    ];

    // Элементы DOM
    const positionInput = document.getElementById('desiredPosition');
    const dropdown = document.getElementById('positionDropdown');
    const statusToggle = document.getElementById('candidateJobStatus');
    const statusText = document.getElementById('statusText');
    const statusHelp = document.getElementById('statusHelp');
    const salaryInput = document.getElementById('desiredSalary');
    const currencySelect = document.getElementById('currency');
    let selectedIndex = -1;

    // ===== ФУНКЦИИ ДЛЯ ФОРМАТИРОВАНИЯ ЗАРПЛАТЫ =====

    // Функция для форматирования числа с пробелами
    function formatSalary(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    // Функция для удаления форматирования (убирает все нецифровые символы)
    function unformatSalary(formattedNumber) {
        return formattedNumber.replace(/\D/g, '');
    }

    // Обработчик ввода для поля зарплаты
    salaryInput.addEventListener('input', function(e) {
        // Сохраняем позицию курсора
        const cursorPosition = e.target.selectionStart;

        // Получаем текущее значение и убираем форматирование
        const unformattedValue = unformatSalary(this.value);

        // Форматируем значение с пробелами
        const formattedValue = formatSalary(unformattedValue);

        // Устанавливаем отформатированное значение
        this.value = formattedValue;

        // Восстанавливаем позицию курсора с учетом добавленных пробелов
        const addedSpaces = formattedValue.length - unformattedValue.length;
        const newCursorPosition = cursorPosition + addedSpaces;

        // Устанавливаем курсор на правильную позицию
        e.target.setSelectionRange(newCursorPosition, newCursorPosition);
    });

    // Блокировка нецифровых символов с клавиатуры (кроме Backspace, Delete и т.д.)
    salaryInput.addEventListener('keydown', function(e) {
        const allowedKeys = [
            '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
            'Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft',
            'ArrowRight', 'ArrowUp', 'ArrowDown'
        ];

        if (!allowedKeys.includes(e.key)) {
            e.preventDefault();
        }
    });

    // Обработчик вставки из буфера обмена
    salaryInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = unformatSalary(text);
        const formatted = formatSalary(numbers);

        // Вставляем отформатированное значение
        document.execCommand('insertText', false, formatted);
    });

    // Обработчик перед отправкой формы - убираем форматирование
    document.getElementById('regForm').addEventListener('submit', function(e) {
        const salaryField = document.getElementById('desiredSalary');
        salaryField.value = unformatSalary(salaryField.value);
    });
    // ===== КОНЕЦ ФУНКЦИЙ ДЛЯ ФОРМАТИРОВАНИЯ ЗАРПЛАТЫ =====

    // Функция для возврата назад
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    // Обработчик изменения статуса
    statusToggle.addEventListener('change', function() {
        if (this.checked) {
            statusText.textContent = '✅ В активном поиске';
            statusText.classList.remove('status-inactive');
            statusText.classList.add('status-active');
            statusHelp.textContent = 'Работодатели увидят ваш профиль и смогут предлагать вам вакансии';
        } else {
            statusText.textContent = '❌ Не ищу работу';
            statusText.classList.remove('status-active');
            statusText.classList.add('status-inactive');
            statusHelp.textContent = 'Ваш профиль будет скрыт от работодателей';
        }
    });

    // Функция фильтрации должностей
    function filterPositions(query) {
        if (!query) return positions;

        return positions.filter(position =>
            position.toLowerCase().includes(query.toLowerCase())
        );
    }

    // Функция отображения предложений
    function showSuggestions(suggestions) {
        dropdown.innerHTML = '';

        if (suggestions.length === 0) {
            dropdown.style.display = 'none';
            return;
        }

        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = suggestion;
            item.addEventListener('click', () => {
                positionInput.value = suggestion;
                dropdown.style.display = 'none';
            });
            dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';
        selectedIndex = -1;
    }

    // Обработчик ввода в поле должности
    positionInput.addEventListener('input', function() {
        const query = this.value;
        const filtered = filterPositions(query);
        showSuggestions(filtered);
    });

    // Обработчик фокуса
    positionInput.addEventListener('focus', function() {
        const query = this.value;
        const filtered = filterPositions(query);
        showSuggestions(filtered);
    });

    // Обработчик клика вне поля ввода
    document.addEventListener('click', function(e) {
        if (!positionInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // Обработчик клавиш для навигации по предложениям
    positionInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.autocomplete-item');

        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
            updateSelection(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            positionInput.value = items[selectedIndex].textContent;
            dropdown.style.display = 'none';
        }
    });

    // Обновление выделенного элемента
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // Обработка отправки формы
    document.getElementById('regForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Показываем состояние загрузки
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.classList.add('loading');
        submitBtn.textContent = 'Сохранение...';

        // Собираем данные формы
        const data = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            desiredPosition: document.getElementById('desiredPosition').value.trim(),
            desiredSalary: document.getElementById('desiredSalary').value.trim(),
            currency: document.getElementById('currency').value,
            candidateJobStatus: document.getElementById('candidateJobStatus').checked ? 'active' : 'inactive',
            formType: 'registration_candidate'
        };

        // Валидация
        if (!data.firstName || !data.lastName || !data.desiredPosition || !data.desiredSalary) {
            if (tg.showAlert) {
                tg.showAlert('Пожалуйста, заполните все поля');
            } else {
                alert('Пожалуйста, заполните все поля');
            }
            submitBtn.classList.remove('loading');
            submitBtn.textContent = '✅ Сохранить профиль';
            return;
        }

        // Отправляем данные в бот
        setTimeout(() => {
            if (tg.sendData) {
                tg.sendData(JSON.stringify(data));
            } else {
                console.log('Данные для отправки:', data);
            }

            // Показываем подтверждение
            if (tg.showPopup) {
                tg.showPopup({
                    title: '✅ Готово!',
                    message: 'Ваш профиль успешно сохранен',
                    buttons: [{ type: 'default', text: 'Отлично', id: 'ok' }]
                }, () => {
                    if (tg.close) {
                        tg.close();
                    } else {
                        goBack();
                    }
                });
            } else {
                alert('✅ Готово! Ваш профиль успешно сохранен');
                setTimeout(() => {
                    goBack();
                }, 1000);
            }
        }, 1000);
    });

    // Автозаполнение из данных Telegram, если есть
    document.addEventListener('DOMContentLoaded', function() {
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;

            if (user.first_name && !document.getElementById('firstName').value) {
                document.getElementById('firstName').value = user.first_name;
            }

            if (user.last_name && !document.getElementById('lastName').value) {
                document.getElementById('lastName').value = user.last_name;
            }
        }
    });

    // Плавное появление формы
    document.addEventListener('DOMContentLoaded', function() {
        document.body.style.opacity = '0';
        document.body.style.transition = 'opacity 0.5s ease';

        setTimeout(() => {
            document.body.style.opacity = '1';
        }, 100);
    });

    // Обработка кнопки "Назад" через Escape или аппаратную кнопку
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            goBack();
        }
    });
</script>
</body>
</html>
